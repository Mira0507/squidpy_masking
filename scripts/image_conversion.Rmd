---
title: "Converting VSI to TIF"
author: "Mira Sohn"
output:
    html_document:
        code_folding: hide
        df_print: paged
        # toc: true
        # toc_float: true
        # toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE,
                      message=FALSE,
                      cache.lazy=FALSE)
```

Last run: `r date()`

This workflow is designed to demonstrate how to convert image files with the `.vsi`
format to `tif` using the `bftools` package. Assume the `bftools` package has been
installed by calling `pip install bftools` after activating your conda environment.

Refer to the following resources for detailed instructions:
- [GitHub repository](https://github.com/BobDotCom/bftools)
- [Command line tools available in Bio-Formats](https://bio-formats.readthedocs.io/en/stable/users/comlinetools/index.html)
- [bfconvert](https://bio-formats.readthedocs.io/en/stable/users/comlinetools/conversion.html)
- [showinf](https://bio-formats.readthedocs.io/en/stable/users/comlinetools/display.html)

```{r rpackages}
library(reticulate)
library(tidyverse)
use_condaenv('../env')
```

```{python ppackages}
# import numpy as np
# import matplotlib.pyplot as plt
# import squidpy as sq
# import napari
import os
import subprocess
import time
```

```{python configs}

# ------------------------------------------------------------------------------
# This chunk is used to specify variables for paths to input files/directories
# and parameter settings
# ------------------------------------------------------------------------------

# Specify the path to input vsi image
vsi = "../images/input/NoPerm/Image_169.vsi"

# Specify the path to output directory
output_dir = "image_conversion"
os.makedirs(output_dir, exist_ok=True)

# Specify the path to output tif file
tif = f"{output_dir}/converted_169_series%02d.ome.tif"

# Specify the path to metadata
meta_out = f"{output_dir}/metadata_169.txt"

# Specify the path to cache directory
cachedir = "image_conversion_cache"

```

# Displaying image metadata

We start from exploring the metadata of input image file using the `showinf` 
command.


```{python explore_metadata}

# ------------------------------------------------------------------------------
# This chunk is used to explore metadata
# ------------------------------------------------------------------------------

# reticulate::repl_python()

# Save the metadata of input images as a text file
subprocess.run(f"showinf {vsi} &> {meta_out}", shell=True)

# Print the saved metadata contents
with open(meta_out, "r") as f:
    print(f.read())

```

```{python run_bfconvert}

# ------------------------------------------------------------------------------
# This chunk runs bfconvert
# ------------------------------------------------------------------------------

# Build command and parameters
cmd = ["bfconvert",
    "-noflat",
    "-compression LZW",
    "-overwrite",
    "-cache",
    f"-cache-dir {cachedir}", 
    vsi,
    tif
    ]
cmd = " ".join(cmd)

# Print the command
print(cmd)

# Call the command along with measuring runtime
def run_runtime(): 
    # Save start time
    start_time = time.time()
    # Run the conversion
    subprocess.run(cmd, shell=True)
    # Save end time
    end_time = time.time()
    # Calculate runtime
    run_time_sec = end_time - start_time
    run_time_min = run_time_sec / 60
    print(f"Runtime: {run_time_sec} seconds ({run_time_min} minutes).")

run_runtime()
```

```{r session_info, collapse=FALSE}
sessionInfo()
```
